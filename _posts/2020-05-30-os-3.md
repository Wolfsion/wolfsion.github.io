---
layout: post
title:  "操作系统内存管理"
date:   2020-05-30
excerpt: "内存管理综述"
tags: [操作系统]
comments: true
---
# 内存管理

## 编译与内存地址

+ 过程
  + 编译
  + 链接
  + 加载
+ 地址绑定
  + **定义**：符号地址到可重定位地址的映射和可重定位地址和绝对地址的映射
  + 地址分类
    + 符号地址
    + 可重定位地址
    + 绝对地址
  + 绑定时机
    + 编译时
    + 加载时
    + 运行时（绝对优势使用）
  + 相关
    + 逻辑地址空间
    + 物理地址空间
    + 映射
+ 动态链接库
  + 动态链接：程序运行时直接从系统库中链接自己需要的库
  + 优势
    + 节省空间：多个链接需求的程序使用同一个副本
    + 改动亲和：一定解耦
    + 版本兼容：通过接口交互
+ 动态加载
  + 定义：一个子程序只有在调用的时候才会被加载，所有的子程序都以可重定位的方式保存在磁盘上
  + 本质：文件系统加载到主存



## 基本实现

+ 交换
  + 应用：增加吞吐量；一定程度解决内存不足的问题
  + 交换策略
  + 多用于移动端操作系统
+ 内存保护
  + 基于Base和Limit判断越界
  + 内核特权
    + 访问任意空间
    + 可修改Base或Limit
  + 重定位与上下文切换
+ 内存分配
  + 空闲空间（孔）
  + 可变分区分配
    + 首次适应
    + 最优适应
    + 最差适应
  + 碎片
    + 外碎片
    + 内碎片
    + 紧缩



## 虚拟内存

+ 基本概念

  + 段
    + 定义：信息的逻辑单位，它含有一组其意义相对完整的信息，用于分类
    + 段表
    + 特性：消除内碎片，存在外碎片
  + 页
    + 定义：分页是为实现离散分配方式，以消除外碎片，提高内存的利用率
    + 页表：
      + 分类：分级页表；哈希页表；反向页表
      + 扩展：访问模式和有效位
    + 特性：消除外碎片，存在内碎片
    + 帧（物理）与页（逻辑）
    + 硬件支持
      + 寄存器组
      + TLB快表
    + 共享页

+ 定义：程序运行于主存的间接独立容器

+ 提出场景

  + 局部性原理
    + 时间局部性：程序某条指令运行，不久的将来该程序大概率会再次运行
    + 空间局部性：某个存储单元被访问，不久的将来该单元附近仍会被访问
  + 局部运行程序
  + **部分装入**，内存空间扩容，提高吞吐量，交换涉及更少的IO
  + 信息共享

+ 基本操作

  + 请求调页

    + 描述：请求后加载

    + 页表

      + 有效位与无效位

    + 缺页错误

      + 处理过程

      `引用发生缺页错误->陷入操作系统->操作系统进行合法调页->调入缺失页到空闲帧->更新页表参数->重新执行指令`

      + 特性：
        + 缺页换入后需重新执行指令
        + 需硬件支持

    + 性能分析

      + 有效访问时间
      + 缺页错误概率

    + 加速支持

      + 交换空间
      + 二进制代码调页

  + 写时复制：针对共享页面，当要写入修改时，为该进程复制出副本。

  + 页面置换

    + 引入场景：当发生缺页中断时，如果操作系统内存中没有空闲页面，则操作系统必须在内存选择一个页面将其移出内存，以便为即将调入的页面让出空间。
    + 关键机制
      + 受害者帧
      + 修改位（脏位）：换出时若该页修改过需要先回写到磁盘
    + 目标：将来较少的缺页错误
    + 表示：引用串，描述引用页的序列
    + 算法
      + FIFO：Belady异常*
      + 最优页面置换算法
      + LRU（Least recently used）页面置换
        + 计数器实现
        + 堆栈实现
        + Reference bit实现
      + LRU近似页面置换*
        + 额外引用位算法
        + 第二次机会算法（时钟算法）
          + 增强第二次算法
      + 基于计数的页面置换*
      + 页面缓冲算法*

  + 帧分配

    + 帧的最小分配数
    + 分配算法
      + 平均分配
      + 比例分配
    + 全局分配与本地分配

+ 问题（抖动）：

  + 描述
  + 原因：最小需求量无法满足不断缺页
  + 解决

+ 内存文件映射：将文件映射到内存空间，应用程序可以通过内存指针对磁盘上的文件进行访问

